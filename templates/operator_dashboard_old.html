<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PortGuard CCMS - Operational Dashboard</title>
    <link rel="stylesheet" href="/static/css/operator_dashboard.css">
</head>
<body>
    <!-- ====================================
         SIDEBAR NAVIGATION
         ==================================== -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">‚öôÔ∏è Operations</div>
            <div class="sidebar-subtitle">Operational Modules</div>
        </div>
        <ul class="sidebar-menu">
            <li class="sidebar-item">
                <a class="sidebar-link active" onclick="switchSidebar('export-packing'); return false;">
                    <span class="sidebar-icon">üì¶</span>
                    <span>Export Packing</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a class="sidebar-link" onclick="switchSidebar('export-truck'); return false;">
                    <span class="sidebar-icon">üöö</span>
                    <span>Export Truck Packing</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a class="sidebar-link" onclick="switchSidebar('import-unpacking'); return false;">
                    <span class="sidebar-icon">üì•</span>
                    <span>Import Unpacking</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a class="sidebar-link" onclick="switchSidebar('truck-unpacking'); return false;">
                    <span class="sidebar-icon">üöõ</span>
                    <span>Truck Unpacking</span>
                </a>
            </li>
            <li class="sidebar-item">
                <a class="sidebar-link" onclick="switchSidebar('damage-reports'); return false;">
                    <span class="sidebar-icon">üî¥</span>
                    <span>Damage Reports</span>
                </a>
            </li>
        </ul>
    </aside>

    <!-- ====================================
         HEADER & TAB NAVIGATION
         ==================================== -->
    <header>
        <div class="header-top">
            <div class="logo">
                PortGuard CCMS v3
            </div>
            <div class="user-info">
                <div class="network-status online" id="networkStatus">
                    <span>Online</span>
                </div>
                <div class="user-profile">
                    <div class="profile-avatar" id="profileAvatar">KC</div>
                    <div class="profile-info">
                        <div class="profile-name" id="profileName">Kyeshav Chettiar</div>
                        <div class="profile-role" id="profileRole">Tally Clerk</div>
                    </div>
                </div>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('overview')">üìä Overview</button>
            <button class="nav-tab" onclick="switchTab('active-jobs')">üì¶ Active Jobs</button>
            <button class="nav-tab" onclick="switchTab('new-jobs')">‚ûï New Containers</button>
            <button class="nav-tab" onclick="switchTab('ready')">‚úÖ Ready for Work</button>
            <button class="nav-tab" onclick="switchTab('in-use')">üîÑ In Use by Others</button>
            <button class="nav-tab" onclick="switchTab('completed')">üèÅ Completed</button>
            <button class="nav-tab" onclick="switchTab('downtime')">‚è±Ô∏è Report Downtime</button>
            <button class="nav-tab" onclick="switchTab('damage')">üî¥ Damage Reports</button>
        </div>
    </header>

    <!-- ====================================
         MAIN CONTENT & DASHBOARD SECTIONS
         ==================================== -->
    <div class="container">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <div>
                <h1 class="dashboard-title" id="dashboardTitle">Welcome to Your Dashboard</h1>
                <p style="color: #888; margin-top: 0.5rem;">Port of Durban Container Clearing & Monitoring System</p>
            </div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="openNewContainer()">
                    ‚ûï New Container
                </button>
                <button class="btn btn-secondary" onclick="switchTab('downtime')">
                    ‚è±Ô∏è Report Downtime
                </button>
            </div>
        </div>

        <!-- Tab: Overview -->
        <div class="tab-content active" id="overview">
            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Containers</div>
                    <div class="stat-value" id="statTotal">0</div>
                    <div class="stat-subtext">in system</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Pending Review</div>
                    <div class="stat-value" id="statPending">0</div>
                    <div class="stat-subtext">awaiting approval</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Needs Repair</div>
                    <div class="stat-value" id="statRepairs">0</div>
                    <div class="stat-subtext">flagged for inspection</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Your Active Job</div>
                    <div class="stat-value" id="statActive">-</div>
                    <div class="stat-subtext">currently assigned</div>
                </div>
            </div>

            <!-- Active Container/Truck -->
            <div class="job-section">
                <h2 class="section-title">‚≠ê Your Active Container</h2>
                <div class="job-card active-job" id="activeJobCard">
                    <div class="active-badge">ACTIVE JOB</div>
                    <div class="job-header">
                        <div class="job-id" id="activeJobId">No active container</div>
                        <span class="job-status status-in-progress">In Progress</span>
                    </div>
                    <div class="job-details">
                        <div class="job-detail">
                            <span class="job-label">Container Type:</span>
                            <span class="job-value" id="activeJobType">-</span>
                        </div>
                        <div class="job-detail">
                            <span class="job-label">Status:</span>
                            <span class="job-value" id="activeJobStatus">-</span>
                        </div>
                        <div class="job-detail">
                            <span class="job-label">Started:</span>
                            <span class="job-value" id="activeJobStarted">-</span>
                        </div>
                    </div>
                    <div class="job-actions">
                        <button onclick="viewContainerDetails('active')">View Details</button>
                        <button onclick="switchTab('downtime')">Report Issue</button>
                    </div>
                </div>
            </div>

            <!-- Quick Stats by Category -->
            <div class="job-section">
                <h2 class="section-title">üìã Job Summary</h2>
                <div class="job-list">
                    <div class="job-card">
                        <div class="job-header">
                            <div class="job-id">New Containers</div>
                            <span class="job-status status-new" id="countNew">0</span>
                        </div>
                        <p style="font-size: 2rem; font-weight: bold; color: #64c8ff; margin: 1rem 0;">Ready to start</p>
                        <button class="btn btn-secondary" onclick="switchTab('new-jobs')" style="width: 100%;">View All</button>
                    </div>
                    <div class="job-card">
                        <div class="job-header">
                            <div class="job-id">Ready for Work</div>
                            <span class="job-status status-ready" id="countReady">0</span>
                        </div>
                        <p style="font-size: 2rem; font-weight: bold; color: #00d084; margin: 1rem 0;">Available jobs</p>
                        <button class="btn btn-secondary" onclick="switchTab('ready')" style="width: 100%;">View All</button>
                    </div>
                    <div class="job-card">
                        <div class="job-header">
                            <div class="job-id">Completed</div>
                            <span class="job-status status-completed" id="countCompleted">0</span>
                        </div>
                        <p style="font-size: 2rem; font-weight: bold; color: #888; margin: 1rem 0;">Finished today</p>
                        <button class="btn btn-secondary" onclick="switchTab('completed')" style="width: 100%;">View All</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Active Jobs -->
        <div class="tab-content" id="active-jobs">
            <div class="job-section">
                <h2 class="section-title">üîÑ Currently Active Containers</h2>
                <div class="job-list" id="activeJobsList">
                    <p style="color: #888; grid-column: 1/-1;">Loading...</p>
                </div>
            </div>
        </div>

        <!-- Tab: New Containers -->
        <div class="tab-content" id="new-jobs">
            <div class="job-section">
                <h2 class="section-title">‚ûï New Containers Available</h2>
                <div class="job-list" id="newJobsList">
                    <p style="color: #888; grid-column: 1/-1;">Loading...</p>
                </div>
            </div>
        </div>

        <!-- Tab: Ready for Work -->
        <div class="tab-content" id="ready">
            <div class="job-section">
                <h2 class="section-title">‚úÖ Ready for Work</h2>
                <div class="job-list" id="readyJobsList">
                    <p style="color: #888; grid-column: 1/-1;">Loading...</p>
                </div>
            </div>
        </div>

        <!-- Tab: In Use by Others -->
        <div class="tab-content" id="in-use">
            <div class="job-section">
                <h2 class="section-title">üîÑ In Use by Others</h2>
                <div class="job-list" id="inUseJobsList">
                    <p style="color: #888; grid-column: 1/-1;">Loading...</p>
                </div>
            </div>
        </div>

        <!-- Tab: Completed -->
        <div class="tab-content" id="completed">
            <div class="job-section">
                <h2 class="section-title">üèÅ Completed Containers</h2>
                <div class="job-list" id="completedJobsList">
                    <p style="color: #888; grid-column: 1/-1;">Loading...</p>
                </div>
            </div>
        </div>

        <!-- Tab: Import Unpacking Module -->
        <div class="tab-content" id="import-unpacking-tab" style="display: none;">
            <div class="container">
                <!-- Module Header -->
                <div class="dashboard-header" style="margin-bottom: 2rem;">
                    <div>
                        <h1 class="dashboard-title">üì• Import Container Unpacking</h1>
                        <p style="color: #888; margin-top: 0.5rem;">Document FCL import container unpacking process from exterior inspection to cargo manifest</p>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="showRegisterFCLForm()">
                            ‚ûï Register FCL Container
                        </button>
                    </div>
                </div>

                <!-- Unpacking Workflow Content (Dynamic) -->
                <div id="import-unpacking-content">
                    <!-- Available FCL Containers -->
                    <div class="job-section">
                        <h2 class="section-title">üì¶ Available FCL Containers</h2>
                        <div class="job-list" id="availableFCLList">
                            <p style="color: #888; grid-column: 1/-1;">Loading containers...</p>
                        </div>
                    </div>

                    <!-- Your Active Unpacking Container -->
                    <div class="job-section">
                        <h2 class="section-title">‚≠ê Your Active Unpacking Container</h2>
                        <div class="job-card active-job" id="activeUnpackingCard">
                            <div class="active-badge">ACTIVE JOB</div>
                            <div class="job-header">
                                <div class="job-id" id="activeUnpackingId">No active container</div>
                                <span class="job-status status-in-progress">In Progress</span>
                            </div>
                            <div class="job-details" id="activeUnpackingDetails" style="display: none;">
                                <div class="job-detail">
                                    <span class="job-label">Container No:</span>
                                    <span class="job-value" id="activeUnpackingNo">-</span>
                                </div>
                                <div class="job-detail">
                                    <span class="job-label">Current Step:</span>
                                    <span class="job-value" id="activeUnpackingStep">-</span>
                                </div>
                                <div class="job-detail">
                                    <span class="job-label">Progress:</span>
                                    <span class="job-value" id="activeUnpackingProgress">-</span>
                                </div>
                            </div>
                            <div class="job-actions" id="activeUnpackingActions" style="display: none;">
                                <button class="btn btn-primary" onclick="continueUnpacking(currentUnpackingSession.containerId)">Continue Unpacking</button>
                                <button class="btn btn-secondary" onclick="viewUnpackingDetails(currentUnpackingSession.containerId)">View Full Details</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Downtime Report -->
        <div class="tab-content" id="downtime">
            <div class="downtime-section">
                <h2 class="section-title">‚è±Ô∏è Report Operational Downtime</h2>
                <form onsubmit="submitDowntimeReport(event)">
                    <div class="downtime-grid">
                        <div class="form-group">
                            <label>Container ID *</label>
                            <input type="text" id="downtimeContainerId" placeholder="Select active container" required>
                        </div>
                        <div class="form-group">
                            <label>Downtime Type *</label>
                            <select id="downtimeType" required>
                                <option value="">Select type...</option>
                                <option value="MECHANICAL">Mechanical Failure</option>
                                <option value="SYSTEM_FAILURE">System Failure</option>
                                <option value="WEATHER">Weather Delay</option>
                                <option value="STAFFING">Staffing Issue</option>
                                <option value="CUSTOMS_DELAY">Customs Delay</option>
                                <option value="MANUAL_HOLD">Manual Hold</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Start Time *</label>
                            <input type="datetime-local" id="downtimeStart" required>
                        </div>
                        <div class="form-group">
                            <label>End Time</label>
                            <input type="datetime-local" id="downtimeEnd">
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 1.5rem;">
                        <label>Reason / Details *</label>
                        <textarea id="downtimeReason" placeholder="Describe the downtime incident..." required></textarea>
                    </div>
                    <button class="btn btn-primary" style="margin-top: 1.5rem;" type="submit">
                        üì§ Submit Downtime Report
                    </button>
                </form>
            </div>
        </div>

        <!-- Tab: Damage Reports -->
        <div class="tab-content" id="damage">
            <div class="job-section">
                <h2 class="section-title">üî¥ Damage & Issue Reports</h2>
                <div class="job-list" id="damageReportsList">
                    <p style="color: #888; grid-column: 1/-1;">Loading...</p>
                </div>
            </div>
        </div>

        <!-- Export Packing Module Page -->
        <div id="exportPackingPage" style="display: none; margin-left: 0; padding-top: 0;">
            <div class="container" style="margin-left: 0;">
                <!-- Module Header -->
                <div class="dashboard-header" style="margin-bottom: 2rem;">
                    <div>
                        <h1 class="dashboard-title">üì¶ Export Container Packing</h1>
                        <p style="color: #888; margin-top: 0.5rem;">Manage export container packing workflow and documentation</p>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="toggleExportPackingPage(false)" style="background: rgba(220, 20, 60, 0.2); color: #dc143c; border: 1px solid #dc143c;">
                            ‚Üê Back to Dashboard
                        </button>
                        <button class="btn btn-primary" onclick="showNewContainerForm()">
                            ‚ûï New Container
                        </button>
                    </div>
                </div>

                <!-- Status Indicators -->
                <div class="stats-grid" style="margin-bottom: 2rem;">
                    <div class="stat-card">
                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">‚è≥</div>
                        <div class="stat-label">New Containers</div>
                        <div class="stat-value" id="exportNewCount">0</div>
                        <div class="stat-subtext">Not started yet</div>
                    </div>
                    <div class="stat-card">
                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">‚úÖ</div>
                        <div class="stat-label">Ready for Work</div>
                        <div class="stat-value" id="exportReadyCount">0</div>
                        <div class="stat-subtext">Available to continue</div>
                    </div>
                    <div class="stat-card">
                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üîÑ</div>
                        <div class="stat-label">In Use</div>
                        <div class="stat-value" id="exportInUseCount">0</div>
                        <div class="stat-subtext">By other inspectors</div>
                    </div>
                    <div class="stat-card">
                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">‚ö†Ô∏è</div>
                        <div class="stat-label">Needs Repair</div>
                        <div class="stat-value" id="exportNeedsRepairCount">0</div>
                        <div class="stat-subtext">Damaged containers</div>
                    </div>
                </div>

                <!-- Ready for Work Section -->
                <div class="job-section">
                    <h2 class="section-title">‚úÖ Ready for Work (<span id="exportReadyWorkCount">0</span>)</h2>
                    <p style="color: #888; margin-bottom: 1rem;">These containers are partially completed and ready for you to continue or finish. Includes repaired containers.</p>
                    <div class="container-cards-grid" id="exportReadyForWorkList" style="min-height: 200px;">
                        <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: #888;">
                            <p>Loading containers...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize dashboard on load
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            loadContainers();
            updateNetworkStatus();
            setInterval(updateNetworkStatus, 5000);
            setInterval(loadDashboardData, 30000); // Refresh every 30 seconds
            setInterval(loadContainers, 10000); // Refresh containers every 10 seconds
        });

        // Load and display containers from API
        async function loadContainers() {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch('/api/containers', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const containers = await response.json();
                    displayReadyForWorkContainers(containers);
                    displayCompletedContainers(containers);
                }
            } catch (error) {
                console.error('Error loading containers:', error);
            }
        }

        // Display containers in Ready for Work section
        function displayReadyForWorkContainers(containers) {
            const list = document.getElementById('readyForWorkList');
            
            // Filter containers that are in progress (REGISTERED, PACKING, UNPACKING) - NOT PENDING_REVIEW
            const inProgressContainers = containers.filter(c => 
                ['REGISTERED', 'PACKING', 'UNPACKING'].includes(c.status)
            );

            // Clear existing cards
            const cards = list.querySelectorAll('.container-card');
            if (cards.length > 3) { // Keep example cards, remove dynamically added ones
                cards.forEach((card, index) => {
                    if (index >= 3) card.remove();
                });
            }

            // Add containers from API
            inProgressContainers.forEach(container => {
                const existing = list.querySelector(`[data-container-id="${container.id}"]`);
                if (existing) return; // Skip if already displayed

                const progress = getProgressForStatus(container.status);
                const card = document.createElement('div');
                card.className = 'container-card';
                card.setAttribute('data-container-id', container.id);
                
                card.innerHTML = `
                    <div class="container-card-header">
                        <span class="container-number">${container.container_no}</span>
                        <span class="container-client">${container.client || 'N/A'}</span>
                    </div>
                    <div class="container-card-details">
                        <div><strong>Vessel:</strong> ${container.vessel_name || 'N/A'}</div>
                        <div><strong>Type:</strong> ${container.type}</div>
                        <div><strong>Status:</strong> <span style="color: #ffa500;">In Progress</span></div>
                        <div style="margin-top: 0.5rem; font-size: 0.85rem; color: #666;">
                            Progress: <strong>${progress.current}/${progress.total} steps</strong>
                        </div>
                    </div>
                    <div class="container-card-footer" style="display: flex; flex-direction: column; gap: 1rem;">
                        <span class="progress-bar">${getProgressBar(progress.current)}</span>
                        <button onclick="viewContainerDetails('${container.id}')" style="width: 100%; padding: 0.75rem; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            ‚ñ∂Ô∏è Continue Packing
                        </button>
                    </div>
                `;

                list.appendChild(card);
            });

            // Update section count
            document.querySelector('.section-title').textContent = `‚úÖ Ready for Work (${inProgressContainers.length})`;
        }

        // Display completed containers
        function displayCompletedContainers(containers) {
            const list = document.getElementById('completedJobsList');
            
            // Filter containers that are completed (PENDING_REVIEW, FINALIZED)
            const completedContainers = containers.filter(c => 
                ['PENDING_REVIEW', 'FINALIZED'].includes(c.status)
            );

            // Clear existing items
            list.innerHTML = '';

            if (completedContainers.length === 0) {
                list.innerHTML = '<p style="color: #888; grid-column: 1/-1;">No completed containers yet</p>';
                return;
            }

            // Add each completed container
            completedContainers.forEach(container => {
                const progress = getProgressForStatus(container.status);
                const statusDisplay = container.status === 'PENDING_REVIEW' ? '‚è≥ Ready for Review' : '‚úÖ Finalized';
                const statusColor = container.status === 'PENDING_REVIEW' ? '#ffa500' : '#00c853';
                
                const card = document.createElement('div');
                card.className = 'container-card';
                card.setAttribute('data-container-id', container.id);
                
                card.innerHTML = `
                    <div class="container-card-header">
                        <span class="container-number">${container.container_no}</span>
                        <span class="container-client">${container.client || 'N/A'}</span>
                    </div>
                    <div class="container-card-details">
                        <div><strong>Vessel:</strong> ${container.vessel_name || 'N/A'}</div>
                        <div><strong>Type:</strong> ${container.type}</div>
                        <div><strong>Status:</strong> <span style="color: ${statusColor};">${statusDisplay}</span></div>
                        <div style="margin-top: 0.5rem; font-size: 0.85rem; color: #666;">
                            Progress: <strong>${progress.current}/${progress.total} steps</strong>
                        </div>
                    </div>
                    <div class="container-card-footer" style="display: flex; flex-direction: column; gap: 1rem;">
                        <span class="progress-bar">${getProgressBar(progress.current)}</span>
                        <button onclick="viewContainerDetails('${container.id}')" style="width: 100%; padding: 0.75rem; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                            üëÅÔ∏è View Details
                        </button>
                    </div>
                `;

                list.appendChild(card);
            });

            // Update completed count in stats
            const completedCountEl = document.getElementById('countCompleted');
            if (completedCountEl) {
                completedCountEl.textContent = completedContainers.length;
            }
        }

        // Get progress steps based on container status
        function getProgressForStatus(status) {
            const progressMap = {
                'REGISTERED': { current: 1, total: 4 },
                'PACKING': { current: 2, total: 4 },
                'UNPACKING': { current: 2, total: 4 },
                'PENDING_REVIEW': { current: 3, total: 4 },
                'FINALIZED': { current: 4, total: 4 }
            };
            return progressMap[status] || { current: 1, total: 4 };
        }

        // Get visual progress bar
        function getProgressBar(steps) {
            const filled = '‚ñì'.repeat(steps);
            const empty = '‚ñë'.repeat(4 - steps);
            return filled + empty;
        }

        // View container details
        function viewContainerDetails(containerId) {
            // Show packing workflow modal for this container
            showPackingWorkflow(containerId);
        }

        // Load dashboard data from API
        async function loadDashboardData() {
            try {
                const response = await fetch('/api/dashboard-stats');
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('statTotal').textContent = data.total || 0;
                    document.getElementById('statPending').textContent = data.pending || 0;
                    document.getElementById('statRepairs').textContent = data.repairs || 0;
                    document.getElementById('countNew').textContent = data.total - data.pending || 0;
                    document.getElementById('countReady').textContent = Math.floor((data.total || 0) * 0.3);
                    document.getElementById('countCompleted').textContent = Math.floor((data.total || 0) * 0.4);
                }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        // Switch tabs
        function switchTab(tabName) {
            // Hide all tabs
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(c => c.classList.remove('active'));

            // Remove active from all nav tabs
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(t => t.classList.remove('active'));

            // Show selected tab
            const tabElement = document.getElementById(tabName);
            if (tabElement) {
                tabElement.classList.add('active');
            }

            // Mark nav tab as active
            event.target.classList.add('active');
        }

        // Switch sidebar modules
        function switchSidebar(module) {
            // Remove active from all sidebar links
            const sidebarLinks = document.querySelectorAll('.sidebar-link');
            sidebarLinks.forEach(link => link.classList.remove('active'));

            // Mark current link as active
            event.target.closest('.sidebar-link').classList.add('active');

            // Handle module-specific actions
            handleSidebarModule(module);
        }

        // Handle sidebar module actions
        function handleSidebarModule(module) {
            switch(module) {
                case 'export-packing':
                    toggleExportPackingPage(true);
                    break;
                case 'export-truck':
                    alert('üöö Export Truck Packing Module\n\n' +
                        'Manage truck-based export packing.\n\n' +
                        'Features:\n' +
                        '‚Ä¢ Track truck load status\n' +
                        '‚Ä¢ Manage truck assignments\n' +
                        '‚Ä¢ Record weight/dimensions\n' +
                        '‚Ä¢ Document loading process');
                    break;
                case 'import-unpacking':
                    toggleImportUnpackingPage(true);
                    break;
                case 'truck-unpacking':
                    alert('üöõ Truck Unpacking Module\n\n' +
                        'Manage truck-based unpacking.\n\n' +
                        'Features:\n' +
                        '‚Ä¢ Track truck arrival\n' +
                        '‚Ä¢ Record cargo details\n' +
                        '‚Ä¢ Log damage reports\n' +
                        '‚Ä¢ Manage truck schedules');
                    break;
                case 'damage-reports':
                    switchTab('damage');
                    break;
            }
        }

        // Toggle Export Packing Page
        function toggleExportPackingPage(show) {
            // Hide all main tabs
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => tab.style.display = 'none');
            
            const header = document.querySelector('header');
            const exportPackingPage = document.getElementById('exportPackingPage');
            
            if (show) {
                header.style.display = 'block';
                exportPackingPage.style.display = 'block';
                loadExportPackingContainers(); // Load containers when switching to this page
                window.scrollTo(0, 0);
            } else {
                header.style.display = 'block';
                exportPackingPage.style.display = 'none';
                // Show overview tab
                document.getElementById('overview').style.display = 'block';
                window.scrollTo(0, 0);
            }
        }

        // Load containers for Export Packing page
        async function loadExportPackingContainers() {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch('/api/containers', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const containers = await response.json();
                    displayExportPackingContainers(containers);
                }
            } catch (error) {
                console.error('Error loading containers:', error);
            }
        }

        // Display containers in Export Packing page
        function displayExportPackingContainers(containers) {
            const list = document.getElementById('exportReadyForWorkList');
            
            // Filter containers that are in progress (REGISTERED, PACKING, UNPACKING, PENDING_REVIEW)
            const inProgressContainers = containers.filter(c => 
                ['REGISTERED', 'PACKING', 'UNPACKING', 'PENDING_REVIEW'].includes(c.status)
            );

            // Clear list
            list.innerHTML = '';

            if (inProgressContainers.length === 0) {
                list.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: #888;"><p>No containers in progress</p></div>';
                document.getElementById('exportReadyWorkCount').textContent = '0';
                return;
            }

            // Update count
            document.getElementById('exportReadyWorkCount').textContent = inProgressContainers.length;

            // Add container cards
            inProgressContainers.forEach(container => {
                const progress = getProgressForStatus(container.status);
                const card = document.createElement('div');
                card.className = 'container-card';
                card.setAttribute('data-container-id', container.id);
                
                card.innerHTML = `
                    <div class="container-card-header">
                        <span class="container-number">${container.container_no}</span>
                        <span class="container-client">${container.client || 'N/A'}</span>
                    </div>
                    <div class="container-card-details">
                        <div><strong>Vessel:</strong> ${container.vessel_name || 'N/A'}</div>
                        <div><strong>Type:</strong> ${container.type}</div>
                        <div><strong>Status:</strong> <span style="color: #ffa500;">In Progress</span></div>
                        <div style="margin-top: 0.5rem; font-size: 0.85rem; color: #666;">
                            Progress: <strong>${progress.current}/${progress.total} steps</strong>
                        </div>
                    </div>
                    <div class="container-card-footer" style="display: flex; flex-direction: column; gap: 1rem;">
                        <span class="progress-bar">${getProgressBar(progress.current)}</span>
                        <button onclick="viewContainerDetails('${container.id}')" style="width: 100%; padding: 0.75rem; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            ‚ñ∂Ô∏è Continue Packing
                        </button>
                    </div>
                `;

                list.appendChild(card);
            });
        }

        // Validate container number with visual feedback
        function validateContainerNumberUI(element) {
            const isValid = validateContainerNumber(element.value.trim());
            const checkmark = document.getElementById('containerNumberCheck');
            
            if (element.value.trim() && isValid) {
                element.style.borderColor = '#00d084';
                checkmark.style.display = 'inline';
                checkmark.style.color = '#00d084';
            } else if (element.value.trim() && !isValid) {
                element.style.borderColor = '#ff6b6b';
                checkmark.style.display = 'none';
            } else {
                element.style.borderColor = '#e0e0e0';
                checkmark.style.display = 'none';
            }
        }

        // Network status check
        function updateNetworkStatus() {
            const statusElement = document.getElementById('networkStatus');
            const isOnline = navigator.onLine;
            
            if (isOnline) {
                statusElement.classList.add('online');
                statusElement.classList.remove('offline');
                statusElement.textContent = '‚óè Online';
            } else {
                statusElement.classList.add('offline');
                statusElement.classList.remove('online');
                statusElement.textContent = '‚óè Offline';
            }
        }

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('token');
                window.location.href = '/login';
            }
        }

        // Open new container dialog
        function openNewContainer() {
            alert('Feature: Create New Container Form\n\nThis will open a dialog to start a new container job.');
        }



        // Submit downtime report
        async function submitDowntimeReport(event) {
            event.preventDefault();
            const data = {
                downtime_type: document.getElementById('downtimeType').value,
                reason: document.getElementById('downtimeReason').value,
                start_time: document.getElementById('downtimeStart').value,
                end_time: document.getElementById('downtimeEnd').value || null
            };

            try {
                const response = await fetch('/api/downtime/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert('‚úÖ Downtime report submitted successfully!');
                    event.target.reset();
                    switchTab('overview');
                } else {
                    alert('‚ùå Error submitting report. Please try again.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Network error. Please check your connection.');
            }
        }

        // ==================== EXPORT PACKING MODULE ====================
        
        // Show New Container Registration Form
        function showNewContainerForm() {
            const modal = document.getElementById('newContainerModal');
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        // Close New Container Modal
        function closeNewContainerModal() {
            const modal = document.getElementById('newContainerModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            document.getElementById('newContainerForm').reset();
            const refSection = document.getElementById('packing-ref-section');
            if (refSection) {
                refSection.innerHTML = '';
            }
        }

        // Validate container number format (11 alphanumeric)
        function validateContainerNumber(value) {
            const regex = /^[A-Z0-9]{11}$/;
            return regex.test(value);
        }

        // Handle client selection change
        function onClientChange(event) {
            const client = event.target.value;
            const refSection = document.getElementById('packing-ref-section');
            const bookingSelect = document.getElementById('vesselBooking');
            const bookingCount = document.getElementById('bookingAvailableCount');
            refSection.innerHTML = '';

            bookingSelect.innerHTML = '<option value="">Select vessel booking</option>';
            bookingSelect.disabled = true;
            if (bookingCount) {
                bookingCount.textContent = '0';
            }

            if (client === 'HULAMIN') {
                refSection.innerHTML = `
                    <div class="form-group">
                        <label style="color: #0f1d3d; font-weight: 600; display: flex; gap: 0.5rem; align-items: center;">
                            Load List References (RE Numbers) 
                            <span style="background: #4caf50; color: white; padding: 0.2rem 0.6rem; border-radius: 4px; font-size: 0.7rem; font-weight: 700;">Hulamin requirement</span>
                        </label>
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                            <input type="text" id="hulaminRefInput" placeholder="e.g., RE123456" 
                                   style="flex: 1; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 4px;">
                            <button type="button" onclick="addHulaminRef()" class="btn btn-secondary" style="white-space: nowrap; padding: 0.75rem 1rem;">+ Add</button>
                        </div>
                        <div id="hulaminRefs" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.5rem;"></div>
                        <small style="color: #0f1d3d; background: #f0f8ff; padding: 0.5rem; border-radius: 4px; display: block;">
                            <strong>Multiple RE Numbers:</strong> If your load list contains multiple RE numbers, add them one by one. Each RE number represents a different load instruction within this container.
                        </small>
                    </div>
                `;
            } else if (client === 'PG_BISON') {
                refSection.innerHTML = `
                    <div class="form-group">
                        <label style="color: #0f1d3d; font-weight: 600; display: flex; gap: 0.5rem; align-items: center;">
                            Load Instruction Reference (HEXP Number) 
                            <span style="background: #4caf50; color: white; padding: 0.2rem 0.6rem; border-radius: 4px; font-size: 0.7rem; font-weight: 700;">PG Bison requirement</span>
                        </label>
                        <input type="text" id="hexpNumber" placeholder="Enter HEXP number (e.g., HEXP2026001)" 
                               style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 4px;">
                        <small style="color: #0f1d3d; display: block; margin-top: 0.5rem;">Example: HEXP2026001</small>
                    </div>
                `;
            }

            if (client) {
                loadBookingsForClient(client);
            }
        }

        async function loadBookingsForClient(client) {
            const bookingSelect = document.getElementById('vesselBooking');
            const bookingCount = document.getElementById('bookingAvailableCount');
            const token = localStorage.getItem('access_token');

            try {
                const response = await fetch(`/api/bookings?client=${encodeURIComponent(client)}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load bookings');
                }

                const bookings = await response.json();
                bookingSelect.innerHTML = '<option value="">Select vessel booking</option>';
                bookings.forEach(booking => {
                    const option = document.createElement('option');
                    option.value = booking.id;
                    option.textContent = `${booking.vessel_name} (${booking.booking_reference})`;
                    option.dataset.containerType = booking.container_type;
                    bookingSelect.appendChild(option);
                });

                bookingSelect.disabled = bookings.length === 0;
                if (bookingCount) {
                    bookingCount.textContent = String(bookings.length);
                }
            } catch (error) {
                console.error('Booking load error:', error);
                bookingSelect.innerHTML = '<option value="">Select client first</option>';
                bookingSelect.disabled = true;
                if (bookingCount) {
                    bookingCount.textContent = '0';
                }
            }
        }

        function onVesselBookingChange(event) {
            const selectedOption = event.target.selectedOptions[0];
            const containerType = document.getElementById('containerType');
            if (selectedOption && selectedOption.dataset.containerType) {
                const typeMap = {
                    '20FT': '20ft',
                    '40FT': '40ft',
                    'HC': '40ft_HC'
                };
                const mapped = typeMap[selectedOption.dataset.containerType] || '';
                containerType.value = mapped;
            }
        }

        // Add Hulamin RE number
        function addHulaminRef() {
            const input = document.getElementById('hulaminRefInput');
            const value = input.value.trim().toUpperCase();

            if (!value) {
                alert('‚ö†Ô∏è Please enter a RE number');
                return;
            }

            if (!/^RE\d+$/.test(value)) {
                alert('‚ö†Ô∏è Invalid format. RE numbers should be like RE123');
                return;
            }

            // Check for duplicates
            const existing = Array.from(document.querySelectorAll('#hulaminRefs .ref-tag'))
                .map(tag => tag.textContent.replace('√ó', '').trim());
            
            if (existing.includes(value)) {
                alert('‚ö†Ô∏è This RE number is already added');
                return;
            }

            const container = document.getElementById('hulaminRefs');
            const tag = document.createElement('div');
            tag.className = 'ref-tag';
            tag.style.cssText = `
                background: rgba(220, 20, 60, 0.2);
                border: 1px solid #dc143c;
                border-radius: 20px;
                padding: 0.5rem 1rem;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                font-size: 0.9rem;
                color: #dc143c;
            `;
            tag.innerHTML = `
                <span>${value}</span>
                <button type="button" onclick="this.parentElement.remove()" style="background: none; border: none; color: #dc143c; cursor: pointer; font-size: 1.2rem;">√ó</button>
            `;
            container.appendChild(tag);
            input.value = '';
            input.focus();
        }

        // Handle new container form submission
        async function submitNewContainer(event) {
            event.preventDefault();

            const containerNum = document.getElementById('containerNumber').value.trim().toUpperCase();
            const client = document.getElementById('client').value;
            const vessel = document.getElementById('vesselBooking').value;
            const containerType = document.getElementById('containerType').value || '40ft';
            const notes = document.getElementById('additionalNotes').value.trim();

            // Validate container number
            if (!validateContainerNumber(containerNum)) {
                alert('‚ùå Invalid container number. Must be exactly 11 alphanumeric characters (e.g., MSMU4557285)');
                return;
            }

            if (!client) {
                alert('‚ùå Please select a client');
                return;
            }

            if (!vessel) {
                alert('‚ùå Please select a vessel booking');
                return;
            }

            // Validate client-specific references
            let clientRef = null;
            if (client === 'HULAMIN') {
                const refs = Array.from(document.querySelectorAll('#hulaminRefs .ref-tag'))
                    .map(tag => tag.textContent.replace('√ó', '').trim());
                if (refs.length === 0) {
                    alert('‚ùå Please add at least one RE number for Hulamin');
                    return;
                }
                clientRef = { re_numbers: refs };
            } else if (client === 'PG_BISON') {
                const hexp = document.getElementById('hexpNumber').value.trim();
                if (!hexp) {
                    alert('‚ùå Please enter HEXP number for PG Bison');
                    return;
                }
                clientRef = { hexp_number: hexp };
            }

            try {
                // Map container type to enum value
                const typeMap = {
                    '20ft': '20FT',
                    '40ft': '40FT',
                    '40ft_HC': 'HC'
                };

                const payload = {
                    container_no: containerNum,
                    booking_id: vessel,
                    type: typeMap[containerType] || '40FT',
                    client: client,
                    client_reference: clientRef,
                    notes: notes
                };

                console.log('Submitting container:', payload);

                // Call backend API to register container
                const token = localStorage.getItem('access_token');
                const response = await fetch('/api/containers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(`‚úÖ Container ${containerNum} registered successfully!\n\nClient: ${client}\nVessel: ${vessel}\nType: ${containerType}`);
                    closeNewContainerModal();
                    loadContainers(); // Reload containers list
                } else {
                    const error = await response.json();
                    console.error('API Error:', error);
                    alert(`‚ùå Error: ${error.detail || 'Failed to register container'}`);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error registering container. Please try again.');
            }
        }

        // ==================== PACKING WORKFLOW ====================
        
        // Start packing for a container
        async function startPacking(containerId) {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`/api/packing/start/${containerId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    loadPackingSession(containerId);
                } else {
                    alert('Failed to start packing session');
                }
            } catch (error) {
                console.error('Error starting packing:', error);
                alert('Error starting packing session');
            }
        }

        // Load packing session progress
        async function loadPackingSession(containerId) {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`/api/packing/${containerId}/progress`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const progress = await response.json();
                    displayPackingProgress(containerId, progress);
                } else {
                    console.error('Failed to load packing progress');
                }
            } catch (error) {
                console.error('Error loading packing session:', error);
            }
        }

        // Display packing progress in UI
        function displayPackingProgress(containerId, progress) {
            // Get required photos based on container type
            const typePhotoMap = {
                '20FT': 4,
                '40FT': 5,
                'HC': 5
            };
            
            // Step descriptions
            const stepDescriptions = {
                'BEFORE_PACKING': {
                    title: 'üì∑ Before Packing - Step 1 of 4',
                    description: 'Take photos of the empty container (interior, exterior, doors)',
                    required: `${typePhotoMap[progress.container_type] || 4} photos minimum`
                },
                'CARGO_PHOTOS': {
                    title: 'üì¶ Cargo Photos - Step 2 of 4',
                    description: 'Document the cargo as it is being loaded into the container',
                    required: `2 photos minimum`
                },
                'AFTER_PACKING': {
                    title: 'üìÆ After Packing - Step 3 of 4',
                    description: 'Document the fully packed container before sealing',
                    required: `2 photos minimum`
                },
                'SEALING': {
                    title: 'üîí Sealing - Step 4 of 4',
                    description: 'Apply seal and capture seal photo with seal number visible',
                    required: 'Seal number required'
                }
            };

            const stepInfo = stepDescriptions[progress.current_step] || {};

            // Update progress info boxes with all photo counts
            const progressSteps = ['BEFORE_PACKING', 'CARGO_PHOTOS', 'AFTER_PACKING', 'SEALING'];
            const progressData = [
                { id: 'step1Status', photos: progress.before_packing_photos, required: typePhotoMap[progress.container_type] || 4 },
                { id: 'step2Status', photos: progress.cargo_photos, required: 2 },
                { id: 'step3Status', photos: progress.after_packing_photos, required: 2 },
                { id: 'step4Status', photos: progress.seal_photo_count, required: 1 }
            ];

            progressData.forEach((step, idx) => {
                const statusEl = document.getElementById(step.id);
                const photosEl = document.getElementById(`step${idx + 1}Photos`);
                
                if (statusEl) {
                    const isComplete = step.photos >= step.required;
                    statusEl.textContent = isComplete ? '‚úÖ' : 'üì∑';
                    statusEl.style.color = isComplete ? '#00c853' : '#999';
                }
                
                if (photosEl) {
                    photosEl.innerHTML = step.photos + ' / ' + step.required;
                    photosEl.style.color = step.photos >= step.required ? '#00c853' : '#dc3545';
                }
            });

            // Update current step details
            const stepTitle = document.getElementById('stepTitle');
            const stepDesc = document.getElementById('stepDescription');
            
            if (stepTitle) {
                stepTitle.textContent = stepInfo.title || 'Loading...';
            }
            
            if (stepDesc) {
                stepDesc.innerHTML = `
                    <p>${stepInfo.description}</p>
                    <p style="color: #0f1d3d; font-weight: 600;">Required: ${stepInfo.required}</p>
                    <p style="color: #666; margin: 0;">Current: ${progress.current_photos} captured</p>
                `;
            }

            // Show sealing form if on step 4
            const stepActionsEl = document.getElementById('stepActions');
            const sealingFormEl = document.getElementById('sealingForm');
            
            if (progress.current_step === 'SEALING') {
                // Hide regular step actions, show sealing form
                if (stepActionsEl) stepActionsEl.style.display = 'none';
                if (sealingFormEl) sealingFormEl.style.display = 'block';
            } else {
                // Show regular step actions, hide sealing form
                if (stepActionsEl) stepActionsEl.style.display = 'block';
                if (sealingFormEl) sealingFormEl.style.display = 'none';
            }

            // Update button states
            const nextStepBtn = document.getElementById('nextStepBtn');
            const completeBtn = document.getElementById('completeBtn');
            const takePhotosBtn = document.getElementById('takePhotosBtn');

            if (nextStepBtn) {
                if (progress.current_step === 'SEALING') {
                    nextStepBtn.style.display = 'none';
                } else {
                    nextStepBtn.style.display = 'inline-block';
                    nextStepBtn.disabled = !progress.is_complete;
                    nextStepBtn.style.opacity = progress.is_complete ? '1' : '0.5';
                    nextStepBtn.style.cursor = progress.is_complete ? 'pointer' : 'not-allowed';
                }
            }

            if (completeBtn) {
                // Enable button if on SEALING step AND (has required photos OR has file selected for upload)
                const sealPhotoInput = document.getElementById('sealPhotoInput');
                const hasPhotoFile = sealPhotoInput && sealPhotoInput.files && sealPhotoInput.files.length > 0;
                const isReadyToComplete = progress.current_step === 'SEALING' && (progress.is_complete || hasPhotoFile);
                
                completeBtn.disabled = !isReadyToComplete;
                completeBtn.style.opacity = isReadyToComplete ? '1' : '0.5';
                completeBtn.style.cursor = isReadyToComplete ? 'pointer' : 'not-allowed';
            }

            if (takePhotosBtn) {
                // Map step to API step name
                const stepMap = {
                    'BEFORE_PACKING': 'BEFORE_PACKING',
                    'CARGO_PHOTOS': 'CARGO_PHOTOS',
                    'AFTER_PACKING': 'AFTER_PACKING',
                    'SEALING': 'SEALING'
                };
                takePhotosBtn.onclick = () => handleTakePhotos(containerId, stepMap[progress.current_step]);
            }
        }

        // Record photos for a step (file upload)
        async function recordPhotos(containerId, step, file) {
            try {
                const token = localStorage.getItem('access_token');
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch(`/api/packing/photo-upload/${containerId}?step=${step}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(`‚úÖ Photo uploaded for ${step.replace('_', ' ')}`);
                    loadPackingSession(containerId);
                    return result;
                } else {
                    const error = await response.json();
                    alert(`‚ùå Error: ${error.detail || 'Failed to upload photo'}`);
                }
            } catch (error) {
                console.error('Error uploading photo:', error);
                alert('Error uploading photo');
            }
        }

        // Advance to next step
        async function advancePackingStep(containerId) {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`/api/packing/advance-step/${containerId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const session = await response.json();
                    alert(`‚úÖ Moved to: ${session.current_step.replace('_', ' ')}`);
                    loadPackingSession(containerId);
                } else {
                    const error = await response.json();
                    alert(`‚ùå Cannot advance: ${error.detail}`);
                }
            } catch (error) {
                console.error('Error advancing step:', error);
                alert('Error advancing to next step');
            }
        }

        // Complete packing with seal
        async function completePacking(containerId, sealNumber, grossMass = null, tareWeight = null, sealPhoto = null) {
            if (!sealNumber) {
                alert('Seal number is required');
                return;
            }

            try {
                const token = localStorage.getItem('access_token');
                
                // If seal photo exists, upload separately first
                if (sealPhoto) {
                    // Validate file
                    const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                    if (!allowedTypes.includes(sealPhoto.type)) {
                        alert('‚ùå Invalid file type. Please upload an image (JPG, PNG, GIF, or WebP)');
                        return;
                    }
                    
                    const maxSize = 10 * 1024 * 1024; // 10MB
                    if (sealPhoto.size > maxSize) {
                        alert('‚ùå File size too large. Maximum 10MB allowed');
                        return;
                    }
                    
                    const formData = new FormData();
                    formData.append('file', sealPhoto);
                    
                    const photoResponse = await fetch(`/api/packing/photo-upload/${containerId}?step=SEALING`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    });
                    
                    if (!photoResponse.ok) {
                        const errorData = await photoResponse.json();
                        alert(`‚ùå Seal photo upload failed: ${errorData.detail || 'Unknown error'}`);
                        return;
                    }
                }

                // Complete packing with seal details
                const response = await fetch(`/api/packing/seal/${containerId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        container_id: containerId,
                        seal_number: sealNumber,
                        gross_mass: grossMass,
                        tare_weight: tareWeight
                    })
                });

                if (response.ok) {
                    const session = await response.json();
                    alert(`‚úÖ Container sealed successfully!\nSeal: ${sealNumber}`);
                    // Reload containers list and switch to completed tab
                    await loadContainers();
                    switchTab('completed');
                    // Close the packing modal after a short delay
                    setTimeout(() => {
                        const modal = document.getElementById('packingModal');
                        if (modal) modal.style.display = 'none';
                    }, 1000);
                } else {
                    const error = await response.json();
                    console.error('Sealing error response:', error);
                    alert(`‚ùå Error: ${error.detail || JSON.stringify(error)}`);
                }
            } catch (error) {
                console.error('Error completing packing:', error);
                alert('‚ùå Error completing packing: ' + error.message);
            }
        }

        // Delete/Clear seal photo
        function clearSealPhoto() {
            const sealPhotoInput = document.getElementById('sealPhotoInput');
            const photoPreview = document.getElementById('photoPreview');
            const completeBtn = document.getElementById('completeBtn');
            
            // Clear the input
            sealPhotoInput.value = '';
            
            // Hide preview
            if (photoPreview) {
                photoPreview.style.display = 'none';
            }
            
            // Disable complete button again
            if (completeBtn) {
                completeBtn.disabled = true;
                completeBtn.style.opacity = '0.5';
                completeBtn.style.cursor = 'not-allowed';
            }
        }

        // Go back to previous step
        async function goBackStep(containerId) {
            try {
                const token = localStorage.getItem('access_token');
                
                // Get current session to find current step
                const response = await fetch(`/api/packing/${containerId}/progress`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const progress = await response.json();
                    const currentStep = progress.current_step;
                    
                    // Steps in order
                    const steps = ['BEFORE_PACKING', 'CARGO_PHOTOS', 'AFTER_PACKING', 'SEALING'];
                    const currentIndex = steps.indexOf(currentStep);
                    
                    if (currentIndex <= 0) {
                        alert('‚ùå Cannot go back from first step');
                        return;
                    }
                    
                    // Confirm going back
                    if (!confirm('‚ö†Ô∏è Going back will reset this step. Are you sure?')) {
                        return;
                    }
                    
                    // Call API to go back (you may need to implement this endpoint)
                    const backResponse = await fetch(`/api/packing/revert-step/${containerId}`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (backResponse.ok) {
                        alert('‚úÖ Moved back to previous step');
                        loadPackingSession(containerId);
                    } else {
                        const error = await backResponse.json();
                        alert(`‚ùå Error: ${error.detail || 'Failed to revert step'}`);
                    }
                }
            } catch (error) {
                console.error('Error going back:', error);
                alert('‚ùå Error: ' + error.message);
            }
        }

        // Check if can advance to next step
        async function checkCanAdvance(containerId) {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`/api/packing/${containerId}/can-advance`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    return result.can_advance;
                }
                return false;
            } catch (error) {
                console.error('Error checking advance:', error);
                return false;
            }
        }

        // Show packing workflow modal
        async function showPackingWorkflow(containerId) {
            // Start packing session
            await startPacking(containerId);
            
            // Load and display progress
            await loadPackingSession(containerId);
            
            // Show modal
            const modal = document.getElementById('packingWorkflowModal');
            if (modal) {
                modal.style.display = 'flex';
                modal.setAttribute('data-container-id', containerId);
                document.body.style.overflow = 'hidden';
            }
        }

        // Close packing workflow modal
        function closePackingWorkflow() {
            const modal = document.getElementById('packingWorkflowModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        // Handle Next Step button click
        async function handleNextStep(containerId) {
            if (!await checkCanAdvance(containerId)) {
                alert('‚ùå Current step not complete. Please capture all required photos.');
                return;
            }

            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`/api/packing/advance-step/${containerId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const session = await response.json();
                    alert(`‚úÖ Advanced to: ${session.current_step.replace('_', ' ')}`);
                    await loadPackingSession(containerId);
                } else {
                    const error = await response.json();
                    alert(`‚ùå ${error.detail}`);
                }
            } catch (error) {
                console.error('Error advancing:', error);
                alert('Error advancing step');
            }
        }

        // Handle Complete & Finish button click
        async function handleCompletePacking(containerId) {
            // Get values from sealing form
            const sealNumberInput = document.getElementById('sealNumberInput');
            const grossMassInput = document.getElementById('grossMassInput');
            const tareWeightInput = document.getElementById('tareWeightInput');
            const sealPhotoInput = document.getElementById('sealPhotoInput');
            
            const sealNumber = sealNumberInput?.value?.trim();
            if (!sealNumber) {
                alert('‚ùå Seal Number is required');
                return;
            }

            const grossMass = grossMassInput?.value?.trim() || null;
            const tareWeight = tareWeightInput?.value?.trim() || null;
            const sealPhoto = sealPhotoInput?.files?.[0] || null;

            await completePacking(containerId, sealNumber, grossMass, tareWeight, sealPhoto);
            closePackingWorkflow();
        }

        // Handle Take Photos button click - open file chooser
        async function handleTakePhotos(containerId, step) {
            // Create hidden file input
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.capture = 'environment'; // On mobile, prefer rear camera
            
            fileInput.addEventListener('change', async function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Show loading state
                    const takePhotosBtn = document.getElementById('takePhotosBtn');
                    const originalText = takePhotosBtn.innerHTML;
                    takePhotosBtn.innerHTML = '‚è≥ Uploading...';
                    takePhotosBtn.disabled = true;
                    
                    // Upload the photo
                    await recordPhotos(containerId, step, file);
                    
                    // Restore button
                    takePhotosBtn.innerHTML = originalText;
                    takePhotosBtn.disabled = false;
                }
            });
            
            // Trigger file picker
            fileInput.click();
        }

        // Handle photo file selection and preview
        document.addEventListener('DOMContentLoaded', function() {
            const sealPhotoInput = document.getElementById('sealPhotoInput');
            if (sealPhotoInput) {
                sealPhotoInput.addEventListener('change', function() {
                    const file = this.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const preview = document.getElementById('photoPreview');
                            const previewImg = document.getElementById('photoPreviewImg');
                            const previewName = document.getElementById('photoPreviewName');
                            
                            previewImg.src = e.target.result;
                            previewName.textContent = file.name;
                            preview.style.display = 'block';
                            
                            // Enable Complete button when photo is selected
                            const completeBtn = document.getElementById('completeBtn');
                            if (completeBtn) {
                                completeBtn.disabled = false;
                                completeBtn.style.opacity = '1';
                                completeBtn.style.cursor = 'pointer';
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        });

        // Handle Pause & Release button click
        async function handlePauseAndRelease(containerId) {
            const confirmPause = confirm('‚è∏Ô∏è Pause & Release Container?\n\nAll your progress will be saved.\nThe container will be available for handover or to be resumed later.');
            if (!confirmPause) return;

            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`/api/packing/${containerId}/pause`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(`‚úÖ ${result.message}`);
                    closePackingWorkflow();
                    loadContainers(); // Reload containers list to show handover status
                } else {
                    const error = await response.json();
                    alert(`‚ùå Error: ${error.detail}`);
                }
            } catch (error) {
                console.error('Error pausing:', error);
                alert('Error pausing container');
            }
        }
    </script>

    <!-- Packing Workflow Modal -->
    <div id="packingWorkflowModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 999; align-items: center; justify-content: center; overflow-y: auto;">
        <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 900px; width: 95%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3); margin: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2 style="color: #0f1d3d; margin: 0; font-size: 1.5rem;">üì¶ Container Packing Workflow</h2>
                <button onclick="closePackingWorkflow()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">‚úï</button>
            </div>

            <!-- Progress Info -->
            <div id="packingProgressInfo" style="padding: 1rem; background: #f0f4ff; border-radius: 8px; margin-bottom: 2rem;">
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 1rem;">
                    <div style="text-align: center; padding: 1rem;">
                        <div style="font-weight: bold; color: #0f1d3d;">Before Packing</div>
                        <div id="step1Status" style="font-size: 2rem;">üì∑</div>
                        <small id="step1Photos">0 photos</small>
                    </div>
                    <div style="text-align: center; padding: 1rem;">
                        <div style="font-weight: bold; color: #0f1d3d;">Cargo Photos</div>
                        <div id="step2Status" style="font-size: 2rem;">üì∑</div>
                        <small id="step2Photos">0 photos</small>
                    </div>
                    <div style="text-align: center; padding: 1rem;">
                        <div style="font-weight: bold; color: #0f1d3d;">After Packing</div>
                        <div id="step3Status" style="font-size: 2rem;">üì∑</div>
                        <small id="step3Photos">0 photos</small>
                    </div>
                    <div style="text-align: center; padding: 1rem;">
                        <div style="font-weight: bold; color: #0f1d3d;">Sealing</div>
                        <div id="step4Status" style="font-size: 2rem;">üîí</div>
                        <small id="step4Seal">No seal</small>
                    </div>
                </div>
            </div>

            <!-- Current Step Content -->
            <div id="currentStepContent" style="padding: 1.5rem; background: #f9f9f9; border-radius: 8px; margin-bottom: 2rem; border-left: 4px solid #0f1d3d;">
                <h3 id="stepTitle" style="color: #0f1d3d; margin-top: 0;">Loading...</h3>
                <p id="stepDescription" style="color: #666;">Please wait...</p>
                
                <div id="stepActions" style="margin-top: 1rem;">
                    <button id="takePhotosBtn" onclick="handleTakePhotos(document.getElementById('packingWorkflowModal').getAttribute('data-container-id'), 'BEFORE_PACKING')" style="padding: 0.75rem 1.5rem; background: #0f1d3d; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 1rem;">üì∏ Take Photos</button>
                    <button id="nextStepBtn" onclick="handleNextStep(document.getElementById('packingWorkflowModal').getAttribute('data-container-id'))" style="padding: 0.75rem 1.5rem; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;" disabled>Next Step ‚Üí</button>
                </div>

                <!-- Sealing Form (Step 4) -->
                <div id="sealingForm" style="display: none; margin-top: 1rem; padding: 1.5rem; background: #f0f4ff; border-radius: 8px; border: 2px solid #0f1d3d;">
                    <h4 style="color: #0f1d3d; margin-top: 0; margin-bottom: 1rem;">üîí Container Sealing & Final Details</h4>
                    
                    <!-- Two Column Layout -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <!-- Left Column: Seal Information -->
                        <div>
                            <div style="margin-bottom: 1.5rem;">
                                <label style="color: #0f1d3d; font-weight: 600; display: block; margin-bottom: 0.5rem;">
                                    Seal Number <span style="color: #dc143c;">*</span>
                                </label>
                                <input type="text" id="sealNumberInput" placeholder="Enter the unique seal number applied to the container" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 4px; font-size: 1rem; font-family: monospace;">
                                <small style="color: #888; display: block; margin-top: 0.25rem;">Enter the unique seal number applied to the container</small>
                            </div>

                            <div style="margin-bottom: 1.5rem;">
                                <label style="color: #0f1d3d; font-weight: 600; display: block; margin-bottom: 0.5rem;">
                                    Gross Mass (kg)
                                </label>
                                <input type="number" id="grossMassInput" placeholder="e.g., 28500" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 4px; font-size: 1rem;">
                                <small style="color: #888; display: block; margin-top: 0.25rem;">Total weight including container and cargo</small>
                            </div>

                            <div>
                                <label style="color: #0f1d3d; font-weight: 600; display: block; margin-bottom: 0.5rem;">
                                    Tare Weight (kg)
                                </label>
                                <input type="number" id="tareWeightInput" placeholder="e.g., 2300" 
                                       style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 4px; font-size: 1rem;">
                                <small style="color: #888; display: block; margin-top: 0.25rem;">Empty container weight</small>
                            </div>
                        </div>

                        <!-- Right Column: Seal Photo -->
                        <div>
                            <label style="color: #0f1d3d; font-weight: 600; display: block; margin-bottom: 0.5rem;">
                                Seal Photo
                            </label>
                            <div style="border: 2px dashed #0f1d3d; border-radius: 8px; padding: 2rem; text-align: center; background: #ffffff;">
                                <div style="margin-bottom: 1rem;">
                                    <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üì∏</div>
                                    <p style="color: #0f1d3d; font-weight: 600; margin: 0; margin-bottom: 0.5rem;">Upload Seal Photo</p>
                                    <p style="color: #888; font-size: 0.9rem; margin: 0;">Take a clear photo of the applied seal<br/>showing the seal number</p>
                                </div>
                                <input type="file" id="sealPhotoInput" accept="image/*" 
                                       style="display: none;">
                                <button type="button" onclick="document.getElementById('sealPhotoInput').click()" 
                                        style="padding: 0.75rem 1.5rem; background: #0f1d3d; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                                    üì∑ Open Camera / Select Photo
                                </button>
                                <div id="photoPreview" style="margin-top: 1rem; display: none;">
                                    <img id="photoPreviewImg" src="" style="max-width: 100%; max-height: 200px; border-radius: 4px; border: 2px solid #e0e0e0;">
                                    <p id="photoPreviewName" style="color: #666; font-size: 0.9rem; margin-top: 0.5rem; word-break: break-word;"></p>
                                    <button type="button" onclick="clearSealPhoto()" 
                                            style="margin-top: 0.75rem; padding: 0.5rem 1rem; background: #dc143c; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.9rem;">
                                        üóëÔ∏è Remove Photo
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Complete Packing -->
            <div style="display: flex; gap: 1rem;">
                <button onclick="closePackingWorkflow()" style="flex: 1; padding: 0.75rem; background: #e0e0e0; color: #333; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">‚ùå Cancel</button>
                <button onclick="goBackStep(document.getElementById('packingWorkflowModal').getAttribute('data-container-id'))" style="flex: 1; padding: 0.75rem; background: #9c27b0; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">‚¨ÖÔ∏è Back Step</button>
                <button onclick="handlePauseAndRelease(document.getElementById('packingWorkflowModal').getAttribute('data-container-id'))" style="flex: 1; padding: 0.75rem; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">‚è∏Ô∏è Pause & Release</button>
                <button id="completeBtn" onclick="handleCompletePacking(document.getElementById('packingWorkflowModal').getAttribute('data-container-id'))" style="flex: 1; padding: 0.75rem; background: #00c853; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;" disabled>‚úÖ Complete & Finish</button>
            </div>
        </div>
    </div>

    <!-- ====================================
         MODALS & DIALOGS
         ==================================== -->

    <!-- New Container Registration Modal -->
    <div id="newContainerModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 900px; width: 95%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2 style="color: #0f1d3d; margin: 0; font-size: 1.5rem;">üì¶ Register Export Container</h2>
                <button onclick="closeNewContainerModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">‚úï</button>
            </div>

            <form id="newContainerForm" onsubmit="submitNewContainer(event)" style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                
                <!-- LEFT COLUMN: Container Details -->
                <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                    <h3 style="color: #0f1d3d; margin: 0; font-size: 1rem; font-weight: 600; border-bottom: 2px solid #e0e0e0; padding-bottom: 0.5rem;">Container Details</h3>

                    <!-- Container Number -->
                    <div class="form-group">
                        <label style="color: #0f1d3d; font-weight: 600; display: flex; gap: 0.5rem; align-items: center;">
                            Container Number 
                            <span style="color: #dc143c;">*</span>
                        </label>
                        <div style="position: relative;">
                            <input type="text" id="containerNumber" placeholder="e.g., MSMU4557285" maxlength="11" 
                                   style="width: 100%; padding: 0.75rem 2rem 0.75rem 0.75rem; border: 2px solid #e0e0e0; border-radius: 4px; font-family: monospace;" 
                                   onchange="validateContainerNumberUI(this)">
                            <span id="containerNumberCheck" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); font-size: 1.2rem; display: none;">‚úì</span>
                        </div>
                        <small style="color: #888;">Format: 4 letters + 7 numbers (e.g., MSMU4557285)</small>
                    </div>

                    <!-- Client Selection -->
                    <div class="form-group">
                        <label style="color: #0f1d3d; font-weight: 600; display: flex; gap: 0.5rem; align-items: center;">
                            Client 
                            <span style="color: #dc143c;">*</span>
                        </label>
                        <select id="client" onchange="onClientChange(event)" 
                                style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 4px; color: #0f1d3d;">
                            <option value="">Select client</option>
                            <option value="HULAMIN">Hulamin</option>
                            <option value="PG_BISON">PG Bison</option>
                            <option value="OTHER">Other</option>
                        </select>
                    </div>

                    <!-- Additional Notes -->
                    <div class="form-group">
                        <label style="color: #0f1d3d; font-weight: 600;">Additional Notes</label>
                        <textarea id="additionalNotes" placeholder="Any special packing instructions or observations..." 
                                  style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 4px; min-height: 100px; resize: vertical;"></textarea>
                    </div>

                    <!-- Client-Specific References (dynamic) -->
                    <div id="packing-ref-section"></div>
                </div>

                <!-- RIGHT COLUMN: Booking Details -->
                <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                    <h3 style="color: #0f1d3d; margin: 0; font-size: 1rem; font-weight: 600; border-bottom: 2px solid #e0e0e0; padding-bottom: 0.5rem;">Booking Details</h3>

                    <!-- Vessel Booking -->
                    <div class="form-group">
                        <label style="color: #0f1d3d; font-weight: 600; display: flex; gap: 0.5rem; align-items: center;">
                            Vessel Booking 
                            <span style="color: #dc143c;">*</span>
                        </label>
                        <select id="vesselBooking" onchange="onVesselBookingChange(event)" disabled
                                style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 4px; color: #0f1d3d;">
                            <option value="">Select client first</option>
                        </select>
                        <small style="color: #999; margin-top: 0.25rem; display: block;">‚ö†Ô∏è <span id="bookingAvailableCount">0</span> booking available for selected client</small>
                        <small style="color: #dc143c; margin-top: 0.25rem; display: block; font-weight: 600;">Select the vessel booking from the dropdown menu, if no booking available , contact your Team Leader or Supervisor</small>
                    </div>

                    <!-- Container Type -->
                    <div class="form-group">
                        <label style="color: #0f1d3d; font-weight: 600;">Container Type</label>
                        <select id="containerType" 
                                style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 4px; color: #0f1d3d;">
                            <option value="">20ft Container</option>
                            <option value="20ft">20ft Standard</option>
                            <option value="40ft">40ft Standard</option>
                            <option value="40ft_HC">40ft High Cube</option>
                        </select>
                    </div>

                    <!-- Spacer for alignment -->
                    <div style="flex: 1;"></div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 1rem; margin-top: auto;">
                        <button type="button" onclick="closeNewContainerModal()" class="btn btn-secondary" style="flex: 1; background: #f0f0f0; color: #333; border: 1px solid #ddd;">Cancel</button>
                        <button type="submit" class="btn btn-primary" style="flex: 1;">Register Container</button>
                    </div>
                </div>
            </form>
        </div>

    <!-- FCL Container Registration Modal -->
    <div id="fclContainerModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 900px; width: 95%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2 style="color: #0f1d3d; margin: 0; font-size: 1.5rem;">üì¶ Register FCL Import Container</h2>
                <button onclick="closeFCLModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">‚úï</button>
            </div>

            <form id="fclRegistrationForm" onsubmit="submitFCLRegistration(event)" style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                
                <!-- LEFT COLUMN: Container Details -->
                <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                    <h3 style="color: #0f1d3d; margin: 0; font-size: 1rem; font-weight: 600; border-bottom: 2px solid #e0e0e0; padding-bottom: 0.5rem;">Container Details</h3>

                    <!-- Container Number -->
                    <div class="form-group">
                        <label style="color: #0f1d3d; font-weight: 600; display: flex; gap: 0.5rem; align-items: center;">
                            Container Number 
                            <span style="color: #dc143c;">*</span>
                        </label>
                        <input type="text" name="container_no" placeholder="e.g., MSMU4557285" maxlength="11" 
                               style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 4px; font-family: monospace;" 
                               required>
                        <small style="color: #888;">Format: 4 letters + 7 numbers (e.g., MSMU4557285)</small>
                    </div>

                    <!-- Container Type -->
                    <div class="form-group">
                        <label style="color: #0f1d3d; font-weight: 600; display: flex; gap: 0.5rem; align-items: center;">
                            Container Type 
                            <span style="color: #dc143c;">*</span>
                        </label>
                        <select name="type" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 4px; color: #0f1d3d;" required>
                            <option value="">Select container type</option>
                            <option value="20ft">20ft Standard</option>
                            <option value="40ft">40ft Standard</option>
                            <option value="40ft_HC">40ft High Cube</option>
                        </select>
                    </div>

                    <!-- Seal Number -->
                    <div class="form-group">
                        <label style="color: #0f1d3d; font-weight: 600;">Seal Number</label>
                        <input type="text" name="seal_no" placeholder="e.g., 1234567" 
                               style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 4px;">
                    </div>

                    <!-- Cargo Type -->
                    <div class="form-group">
                        <label style="color: #0f1d3d; font-weight: 600;">Cargo Type</label>
                        <input type="text" name="cargo_type" placeholder="e.g., Household Goods, Electronics..." 
                               style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 4px;">
                    </div>

                    <!-- Additional Notes -->
                    <div class="form-group">
                        <label style="color: #0f1d3d; font-weight: 600;">Additional Notes</label>
                        <textarea name="notes" placeholder="Any special handling instructions or observations..." 
                                  style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 4px; min-height: 80px; resize: vertical;"></textarea>
                    </div>
                </div>

                <!-- RIGHT COLUMN: Booking & Import Details -->
                <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                    <h3 style="color: #0f1d3d; margin: 0; font-size: 1rem; font-weight: 600; border-bottom: 2px solid #e0e0e0; padding-bottom: 0.5rem;">Import Details</h3>

                    <!-- Booking Selection -->
                    <div class="form-group">
                        <label style="color: #0f1d3d; font-weight: 600; display: flex; gap: 0.5rem; align-items: center;">
                            Vessel Booking 
                            <span style="color: #dc143c;">*</span>
                        </label>
                        <select name="booking_id" id="fclBooking"
                                style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 4px; color: #0f1d3d;" required>
                            <option value="">Select a booking...</option>
                        </select>
                        <small style="color: #999; margin-top: 0.25rem; display: block;">Select the booking for this FCL container</small>
                    </div>

                    <!-- Client -->
                    <div class="form-group">
                        <label style="color: #0f1d3d; font-weight: 600;">Client</label>
                        <input type="text" name="client" id="fclClient" placeholder="Auto-populated from booking" 
                               style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 4px;" 
                               readonly>
                    </div>

                    <!-- Vessel Name -->
                    <div class="form-group">
                        <label style="color: #0f1d3d; font-weight: 600;">Vessel Name</label>
                        <input type="text" id="fclVesselName" placeholder="Auto-populated from booking" 
                               style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 4px;" 
                               readonly>
                    </div>

                    <!-- Arrival Date -->
                    <div class="form-group">
                        <label style="color: #0f1d3d; font-weight: 600; display: flex; gap: 0.5rem; align-items: center;">
                            Arrival Date 
                            <span style="color: #dc143c;">*</span>
                        </label>
                        <input type="datetime-local" name="arrival_date" 
                               style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 4px;" 
                               required>
                    </div>

                    <!-- Unpacking Location -->
                    <div class="form-group">
                        <label style="color: #0f1d3d; font-weight: 600;">Unpacking Location</label>
                        <input type="text" name="unpacking_location" placeholder="e.g., Port A, Warehouse 3..." 
                               style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 4px;">
                    </div>

                    <!-- Spacer for alignment -->
                    <div style="flex: 1;"></div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 1rem; margin-top: auto;">
                        <button type="button" onclick="closeFCLModal()" class="btn btn-secondary" style="flex: 1; background: #f0f0f0; color: #333; border: 1px solid #ddd;">Cancel</button>
                        <button type="submit" class="btn btn-primary" style="flex: 1;">Register FCL Container</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- ====================================
         UNPACKING WORKFLOW MODALS
         ==================================== -->

    <!-- Unpacking Workflow Session Modal -->
    <div id="unpackingWorkflowModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 2000; overflow-y: auto;">
        <div style="background: white; margin: 2rem auto; border-radius: 12px; max-width: 1000px; width: 95%; box-shadow: 0 10px 40px rgba(0,0,0,0.3); min-height: 500px;">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2 style="margin: 0; font-size: 1.5rem;">üì• Import Container Unpacking Workflow</h2>
                    <p id="unpackingContainerDisplay" style="margin-top: 0.5rem; opacity: 0.9;">Container: --</p>
                </div>
                <button onclick="closeUnpackingWorkflow()" style="background: none; border: none; font-size: 2rem; cursor: pointer; color: white;">‚úï</button>
            </div>

            <!-- Workflow Progress Timeline -->
            <div style="padding: 2rem; border-bottom: 1px solid #e0e0e0;">
                <h3 style="margin: 0 0 1.5rem 0; color: #0f1d3d;">Workflow Progress</h3>
                <div style="display: flex; justify-content: space-between; gap: 0.5rem; flex-wrap: wrap;">
                    <div class="workflow-step" data-step="EXTERIOR_INSPECTION" onclick="switchUnpackingStep('EXTERIOR_INSPECTION')" style="flex: 1; min-width: 150px; text-align: center; padding: 1rem; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; background: white; transition: all 0.3s;">
                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üì∑</div>
                        <div style="font-size: 0.85rem; font-weight: 600; color: #333;">Exterior Inspection</div>
                    </div>
                    <div class="workflow-step" data-step="DOOR_OPENING" onclick="switchUnpackingStep('DOOR_OPENING')" style="flex: 1; min-width: 150px; text-align: center; padding: 1rem; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; background: white; transition: all 0.3s;">
                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üö™</div>
                        <div style="font-size: 0.85rem; font-weight: 600; color: #333;">Door Opening</div>
                    </div>
                    <div class="workflow-step" data-step="INTERIOR_INSPECTION" onclick="switchUnpackingStep('INTERIOR_INSPECTION')" style="flex: 1; min-width: 150px; text-align: center; padding: 1rem; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; background: white; transition: all 0.3s;">
                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üîç</div>
                        <div style="font-size: 0.85rem; font-weight: 600; color: #333;">Interior Inspection</div>
                    </div>
                    <div class="workflow-step" data-step="CARGO_UNLOADING" onclick="switchUnpackingStep('CARGO_UNLOADING')" style="flex: 1; min-width: 150px; text-align: center; padding: 1rem; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; background: white; transition: all 0.3s;">
                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üì¶</div>
                        <div style="font-size: 0.85rem; font-weight: 600; color: #333;">Cargo Unloading</div>
                    </div>
                    <div class="workflow-step" data-step="CARGO_MANIFEST" onclick="switchUnpackingStep('CARGO_MANIFEST')" style="flex: 1; min-width: 150px; text-align: center; padding: 1rem; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; background: white; transition: all 0.3s;">
                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üìã</div>
                        <div style="font-size: 0.85rem; font-weight: 600; color: #333;">Cargo Manifest</div>
                    </div>
                    <div class="workflow-step" data-step="FINAL_INSPECTION" onclick="switchUnpackingStep('FINAL_INSPECTION')" style="flex: 1; min-width: 150px; text-align: center; padding: 1rem; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; background: white; transition: all 0.3s;">
                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">‚úÖ</div>
                        <div style="font-size: 0.85rem; font-weight: 600; color: #333;">Final Inspection</div>
                    </div>
                </div>
            </div>

            <!-- Step Content Area -->
            <div id="unpackingStepContent" style="padding: 2rem; min-height: 400px;">
                <!-- Content will be populated dynamically -->
            </div>

            <!-- Action Buttons -->
            <div style="padding: 2rem; border-top: 1px solid #e0e0e0; display: flex; gap: 1rem; justify-content: flex-end;">
                <button onclick="closeUnpackingWorkflow()" class="btn btn-secondary" style="background: #f0f0f0; color: #333; border: 1px solid #ddd;">Close</button>
                <button onclick="saveUnpackingProgress()" class="btn btn-primary">Save Progress</button>
                <button onclick="completeUnpacking()" class="btn" style="background: #28a745; color: white; border: none;">Complete Unpacking</button>
            </div>
        </div>
    </div>

    <!-- Photo Upload Modal -->
    <div id="photoUploadModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 2100; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 600px; width: 95%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2 style="color: #0f1d3d; margin: 0; font-size: 1.3rem;">üì∑ Upload Photos</h2>
                <button onclick="closePhotoModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">‚úï</button>
            </div>

            <p id="photoModalStep" style="color: #666; margin-bottom: 1.5rem;">Step: --</p>

            <div style="border: 2px dashed #667eea; border-radius: 8px; padding: 2rem; text-align: center; background: #f8f9ff; margin-bottom: 1.5rem;" id="photoDropZone">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üì∏</div>
                <p style="color: #666; margin: 0;">Drag & drop photos here or</p>
                <input type="file" id="photoFileInput" multiple accept="image/*" style="display: none;">
                <button type="button" onclick="document.getElementById('photoFileInput').click()" class="btn btn-secondary" style="margin-top: 1rem;">Select Photos</button>
                <div id="photoList" style="margin-top: 1rem; text-align: left;"></div>
            </div>

            <div style="display: flex; gap: 1rem;">
                <button onclick="closePhotoModal()" class="btn btn-secondary" style="flex: 1; background: #f0f0f0; color: #333; border: 1px solid #ddd;">Cancel</button>
                <button onclick="uploadPhotos()" class="btn btn-primary" style="flex: 1;">Upload Photos</button>
            </div>
        </div>
    </div>

    <!-- Damage Report Modal -->
    <div id="damageReportModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 2100; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 700px; width: 95%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2 style="color: #0f1d3d; margin: 0; font-size: 1.3rem;">üî¥ Report Damage / Discrepancy</h2>
                <button onclick="closeDamageModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">‚úï</button>
            </div>

            <form onsubmit="submitDamageReport(event)" style="display: flex; flex-direction: column; gap: 1.5rem;">
                <div class="form-group">
                    <label style="color: #0f1d3d; font-weight: 600;">Damage Type *</label>
                    <select id="damageType" required style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 4px;">
                        <option value="">Select damage type...</option>
                        <option value="CONTAINER_DAMAGE">Container Damage</option>
                        <option value="CARGO_DAMAGE">Cargo Damage</option>
                        <option value="MISSING_ITEMS">Missing Items</option>
                        <option value="WEIGHT_DISCREPANCY">Weight Discrepancy</option>
                        <option value="SEAL_BROKEN">Seal Broken/Tampered</option>
                        <option value="OTHER">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label style="color: #0f1d3d; font-weight: 600;">Severity Level *</label>
                    <select id="damageSeverity" required style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 4px;">
                        <option value="">Select severity...</option>
                        <option value="MINOR">Minor</option>
                        <option value="MODERATE">Moderate</option>
                        <option value="SEVERE">Severe</option>
                        <option value="CRITICAL">Critical</option>
                    </select>
                </div>

                <div class="form-group">
                    <label style="color: #0f1d3d; font-weight: 600;">Description *</label>
                    <textarea id="damageDescription" placeholder="Describe the damage in detail..." required style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 4px; min-height: 120px; font-family: inherit;"></textarea>
                </div>

                <div class="form-group">
                    <label style="color: #0f1d3d; font-weight: 600;">Affected Items/Location</label>
                    <input type="text" id="damageLocation" placeholder="e.g., Door hinge, Top corner, Item #5..." style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 4px;">
                </div>

                <div style="display: flex; gap: 1rem;">
                    <button type="button" onclick="closeDamageModal()" class="btn btn-secondary" style="flex: 1; background: #f0f0f0; color: #333; border: 1px solid #ddd;">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Submit Damage Report</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ====================================
         INLINE SCRIPTS (Legacy - For Existing Workflows)
         ==================================== -->
        <!-- ========== FCL CONTAINER REGISTRATION FUNCTIONS ========== -->
        <script>
        // Store bookings data
        let fclBookingsData = {};

        // Load available bookings when modal opens
        async function loadFCLBookings() {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch('/api/bookings', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const bookings = await response.json();
                    
                    // Store bookings by ID for later lookup
                    fclBookingsData = {};
                    bookings.forEach(booking => {
                        fclBookingsData[booking.id] = booking;
                    });

                    // Populate dropdown
                    const bookingSelect = document.getElementById('fclBooking');
                    bookingSelect.innerHTML = '<option value="">Select a booking...</option>';
                    bookings.forEach(booking => {
                        const option = document.createElement('option');
                        option.value = booking.id;
                        option.textContent = `${booking.booking_reference} - ${booking.vessel_name} (${booking.client})`;
                        bookingSelect.appendChild(option);
                    });
                } else {
                    console.error('Failed to load bookings');
                    document.getElementById('fclBooking').innerHTML = '<option value="">Error loading bookings</option>';
                }
            } catch (error) {
                console.error('Error loading FCL bookings:', error);
            }
        }

        // Update vessel name when booking is selected
        function updateVesselFromBooking() {
            const bookingId = document.getElementById('fclBooking').value;
            const booking = fclBookingsData[bookingId];
            
            if (booking) {
                document.getElementById('fclVesselName').value = booking.vessel_name || '';
                document.getElementById('fclClient').value = booking.client || '';
            }
        }

        // Show FCL Container Registration Modal
        function showRegisterFCLForm() {
            const modal = document.getElementById('fclContainerModal');
            if (modal) {
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                loadFCLBookings();
            } else {
                console.error('Modal not found!');
                alert('Error: Modal not found. Please refresh the page.');
            }
        }

        // Close FCL Modal
        function closeFCLModal() {
            const modal = document.getElementById('fclContainerModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
                const form = document.getElementById('fclRegistrationForm');
                if (form) form.reset();
            }
        }

        // Submit FCL Container Registration
        async function submitFCLRegistration(event) {
            event.preventDefault();

            try {
                const token = localStorage.getItem('access_token');
                
                // Get form data
                const formData = new FormData(document.getElementById('fclRegistrationForm'));
                
                // Convert to JSON object
                const containerData = {
                    container_no: formData.get('container_no').toUpperCase(),
                    type: formData.get('type'),
                    booking_id: formData.get('booking_id'),
                    arrival_date: formData.get('arrival_date') ? new Date(formData.get('arrival_date')).toISOString() : null,
                    client: formData.get('client'),
                    cargo_type: formData.get('cargo_type'),
                    seal_no: formData.get('seal_no'),
                    unpacking_location: formData.get('unpacking_location'),
                    notes: formData.get('notes')
                };

                // Validate required fields
                if (!containerData.container_no || !containerData.type || !containerData.booking_id || !containerData.arrival_date) {
                    alert('‚ùå Please fill in all required fields (marked with *)');
                    return;
                }

                // Submit to backend
                const response = await fetch('/api/containers', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(containerData)
                });

                if (response.ok) {
                    const container = await response.json();
                    alert(`‚úÖ Container ${container.container_no} registered successfully!\nContainer ID: ${container.id}\n\nReady to start unpacking workflow.`);
                    
                    // Close modal and refresh list
                    closeFCLModal();
                    loadAvailableFCLContainers();
                } else {
                    const error = await response.json();
                    alert(`‚ùå Error: ${error.detail || 'Failed to register container'}`);
                }
            } catch (error) {
                console.error('Error registering FCL container:', error);
                alert('‚ùå Error registering container: ' + error.message);
            }
        }
        </script>
        <!-- ========== END FCL REGISTRATION FUNCTIONS ========== -->

        <!-- ========== IMPORT UNPACKING FUNCTIONS ========== -->
        <script>
        // Toggle Import Unpacking Page
        function toggleImportUnpackingPage(show) {
            // Hide all main tabs
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => tab.style.display = 'none');
            
            const header = document.querySelector('header');
            const unpackingTab = document.getElementById('import-unpacking-tab');
            
            if (show) {
                header.style.display = 'block';
                unpackingTab.style.display = 'block';
                loadAvailableFCLContainers(); // Load FCL containers
                window.scrollTo(0, 0);
            } else {
                header.style.display = 'block';
                unpackingTab.style.display = 'none';
                // Show overview tab
                document.getElementById('overview').style.display = 'block';
                window.scrollTo(0, 0);
            }
        }

        // Load available FCL containers
        async function loadAvailableFCLContainers() {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch('/api/containers', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const containers = await response.json();
                    displayAvailableFCLContainers(containers);
                }
            } catch (error) {
                console.error('Error loading FCL containers:', error);
            }
        }

        // Display available FCL containers
        function displayAvailableFCLContainers(containers) {
            const list = document.getElementById('availableFCLList');
            
            // Filter containers that are in unpacking status
            const unpackingContainers = containers.filter(c => 
                ['REGISTERED', 'UNPACKING'].includes(c.status)
            );

            // Clear existing cards
            list.innerHTML = '';

            if (unpackingContainers.length === 0) {
                list.innerHTML = '<p style="color: #888; grid-column: 1/-1;">No FCL containers available</p>';
                return;
            }

            // Add each container
            unpackingContainers.forEach(container => {
                const card = document.createElement('div');
                card.className = 'container-card';
                card.setAttribute('data-container-id', container.id);
                
                card.innerHTML = `
                    <div class="container-card-header">
                        <span class="container-number">${container.container_no}</span>
                        <span class="container-client">${container.client || 'N/A'}</span>
                    </div>
                    <div class="container-card-details">
                        <div><strong>Vessel:</strong> ${container.vessel_name || 'N/A'}</div>
                        <div><strong>Type:</strong> ${container.type}</div>
                        <div><strong>Status:</strong> <span style="color: #0066cc;">${container.status === 'UNPACKING' ? 'üîÑ Unpacking' : '‚è≥ Registered'}</span></div>
                    </div>
                    <div class="container-card-footer">
                        <button onclick="startUnpackingWorkflow('${container.id}')" style="width: 100%; padding: 0.75rem; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                            üì• Start/Continue Unpacking
                        </button>
                    </div>
                `;

                list.appendChild(card);
            });
        }

        // Start unpacking workflow
        async function startUnpackingWorkflow(containerId) {
            try {
                const token = localStorage.getItem('access_token');
                
                // Start unpacking workflow
                const response = await fetch(`/api/unpacking/${containerId}/start`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const session = await response.json();
                    alert('‚úÖ Unpacking workflow started!');
                    
                    // Load unpacking interface
                    loadUnpackingInterface(containerId, session);
                    
                    // Reload available containers
                    loadAvailableFCLContainers();
                } else {
                    const error = await response.json();
                    alert(`‚ùå Error: ${error.detail}`);
                }
            } catch (error) {
                console.error('Error starting unpacking:', error);
                alert('‚ùå Error starting unpacking: ' + error.message);
            }
        }

        // Load unpacking interface
        async function loadUnpackingInterface(containerId, session) {
            try {
                const token = localStorage.getItem('access_token');
                
                // Get progress
                const response = await fetch(`/api/unpacking/${containerId}/progress`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const progress = await response.json();
                    displayUnpackingProgress(containerId, progress);
                }
            } catch (error) {
                console.error('Error loading unpacking progress:', error);
            }
        }

        // Store current unpacking session data
        let currentUnpackingSession = {
            containerId: null,
            progress: null
        };

        // Display unpacking progress with detailed 6-step UI
        function displayUnpackingProgress(containerId, progress) {
            currentUnpackingSession.containerId = containerId;
            currentUnpackingSession.progress = progress;

            const steps = ['EXTERIOR_INSPECTION', 'DOOR_OPENING', 'INTERIOR_INSPECTION', 'CARGO_UNLOADING', 'CARGO_MANIFEST', 'FINAL_INSPECTION'];
            const stepLabels = {
                'EXTERIOR_INSPECTION': 'üì¶ Exterior Inspection',
                'DOOR_OPENING': 'üö™ Door Opening',
                'INTERIOR_INSPECTION': 'üîç Interior Inspection',
                'CARGO_UNLOADING': 'üì¶ Cargo Unloading',
                'CARGO_MANIFEST': 'üìã Cargo Manifest',
                'FINAL_INSPECTION': '‚úÖ Final Inspection'
            };
            const stepDescriptions = {
                'EXTERIOR_INSPECTION': 'Inspect exterior condition. Take 3 photos from different angles.',
                'DOOR_OPENING': 'Inspect door condition and verify seal. Take 2 photos.',
                'INTERIOR_INSPECTION': 'Inspect interior condition. Take 3 photos from different angles.',
                'CARGO_UNLOADING': 'Document cargo unloading process. Take 2 photos.',
                'CARGO_MANIFEST': 'Record cargo manifest and items. Take 1 document photo.',
                'FINAL_INSPECTION': 'Final container inspection. Take 2 photos.'
            };

            const currentIndex = steps.indexOf(progress.current_step);
            const progressPercent = Math.round(((currentIndex + 1) / steps.length) * 100);

            // Build step indicators
            let stepsHTML = '<div class="unpacking-steps-container" style="display: flex; gap: 0.5rem; margin-bottom: 2rem; flex-wrap: wrap;">';
            steps.forEach((step, index) => {
                const isActive = step === progress.current_step;
                const isCompleted = index < currentIndex;
                const photoCount = getPhotoCount(progress, step);
                const photoRequired = getPhotoRequired(step);
                const isStepComplete = photoCount >= photoRequired;

                let stepStatus = isCompleted ? '‚úÖ' : (isActive ? '‚è±Ô∏è' : '‚≠ï');
                if (!isActive && !isCompleted && photoCount > 0) stepStatus = 'üìç';

                stepsHTML += `
                <div class="step-indicator" style="
                    flex: 1; min-width: 120px;
                    padding: 1rem; 
                    border-radius: 8px; 
                    border: 2px solid ${isActive ? '#0066cc' : isCompleted ? '#28a745' : photoCount > 0 ? '#ff9800' : '#ddd'};
                    background: ${isActive ? '#e3f2fd' : isCompleted ? '#f0f9ff' : '#fafafa'};
                    text-align: center;
                    cursor: pointer;
                    transition: all 0.3s ease;
                ">
                    <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">${stepStatus}</div>
                    <div style="font-weight: 600; color: #001a4d; margin-bottom: 0.25rem; font-size: 0.85rem;">
                        ${step.replace(/_/g, ' ')}
                    </div>
                    <div style="font-size: 0.75rem; color: #666;">
                        üì∑ ${photoCount}/${photoRequired}
                    </div>
                </div>
                `;
            });
            stepsHTML += '</div>';

            // Build current step detail section
            let currentStepHTML = `
            <div class="current-step-section" style="
                background: linear-gradient(135deg, #e3f2fd 0%, #f3f7ff 100%);
                border-left: 4px solid #0066cc;
                padding: 1.5rem;
                border-radius: 8px;
                margin-bottom: 2rem;
            ">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div>
                        <h3 style="margin: 0; color: #0066cc; font-size: 1.3rem;">${stepLabels[progress.current_step]}</h3>
                        <p style="margin: 0.5rem 0 0 0; color: #666;">${stepDescriptions[progress.current_step]}</p>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 2.5rem; font-weight: bold; color: #0066cc;">${progressPercent}%</div>
                        <div style="color: #666; font-size: 0.9rem;">Complete</div>
                    </div>
                </div>
                <div style="width: 100%; height: 8px; background: #ddd; border-radius: 4px; overflow: hidden;">
                    <div style="height: 100%; width: ${progressPercent}%; background: linear-gradient(90deg, #0066cc, #0088ff); transition: width 0.3s ease;"></div>
                </div>
            </div>
            `;

            // Build photo gallery and actions section
            let galleryHTML = `
            <div class="unpacking-details-section" style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                <!-- Photo Gallery -->
                <div class="photo-gallery-section">
                    <h4 style="color: #0066cc; margin-bottom: 1rem; border-bottom: 2px solid #0066cc; padding-bottom: 0.5rem;">
                        üì∏ Photo Gallery - ${progress.current_step}
                    </h4>
                    <div id="photoGallery-${containerId}" style="
                        background: #f9f9f9;
                        border: 2px dashed #ddd;
                        border-radius: 8px;
                        padding: 1rem;
                        min-height: 200px;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                    ">
                        <div style="text-align: center;">
                            <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üì∑</div>
                            <div style="color: #666; margin-bottom: 1rem;">
                                <div style="font-weight: 600;">Photos for ${progress.current_step}</div>
                                <div style="font-size: 0.9rem; color: #999;">
                                    ${getPhotoCount(progress, progress.current_step)}/${getPhotoRequired(progress.current_step)} photos uploaded
                                </div>
                            </div>
                            <input type="file" id="photoUpload-${containerId}" multiple accept="image/*" style="display: none;" onchange="uploadUnpackingPhotos('${containerId}')">
                            <button onclick="document.getElementById('photoUpload-${containerId}').click()" style="
                                background: #0066cc; color: white; border: none; padding: 0.75rem 1.5rem;
                                border-radius: 4px; cursor: pointer; font-weight: 600;
                            ">+ Upload Photos</button>
                        </div>
                    </div>
                </div>

                <!-- Step Actions -->
                <div class="step-actions-section">
                    <h4 style="color: #0066cc; margin-bottom: 1rem; border-bottom: 2px solid #0066cc; padding-bottom: 0.5rem;">
                        ‚öôÔ∏è Step Actions
                    </h4>
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <!-- Advance Step Button -->
                        <button onclick="advanceUnpackingStep('${containerId}')" style="
                            width: 100%; padding: 0.75rem; background: #28a745; color: white; border: none;
                            border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.95rem;
                        ">
                            ‚úì Advance to Next Step
                        </button>

                        <!-- Revert Step Button -->
                        ${currentIndex > 0 ? `
                        <button onclick="revertUnpackingStep('${containerId}')" style="
                            width: 100%; padding: 0.75rem; background: #ffc107; color: #333; border: none;
                            border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.95rem;
                        ">
                            ‚Ü∂ Revert to Previous Step
                        </button>
                        ` : ''}

                        <!-- Damage Report (for later steps) -->
                        ${['INTERIOR_INSPECTION', 'CARGO_UNLOADING', 'FINAL_INSPECTION'].includes(progress.current_step) ? `
                        <button onclick="showDamageReportModal('${containerId}')" style="
                            width: 100%; padding: 0.75rem; background: #dc3545; color: white; border: none;
                            border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.95rem;
                        ">
                            ‚ö†Ô∏è Report Damage/Discrepancy
                        </button>
                        ` : ''}

                        <!-- Complete Unpacking (final step) -->
                        ${progress.current_step === 'FINAL_INSPECTION' ? `
                        <button onclick="completeUnpacking('${containerId}')" style="
                            width: 100%; padding: 0.75rem; background: #007bff; color: white; border: none;
                            border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.95rem; margin-top: 1rem;
                        ">
                            ‚úÖ Complete Unpacking Workflow
                        </button>
                        ` : ''}
                    </div>
                </div>
            </div>
            `;

            // Build summary section
            let summaryHTML = `
            <div class="unpacking-summary" style="
                background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 1.5rem;
                margin-bottom: 2rem;
            ">
                <h4 style="margin: 0 0 1rem 0; color: #856404;">üìä Unpacking Summary</h4>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1rem;">
                    <div style="background: white; padding: 0.75rem; border-radius: 4px; text-align: center;">
                        <div style="font-size: 0.85rem; color: #666;">Exterior Photos</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #0066cc;">${progress.exterior_inspection_photos}/3</div>
                    </div>
                    <div style="background: white; padding: 0.75rem; border-radius: 4px; text-align: center;">
                        <div style="font-size: 0.85rem; color: #666;">Door Photos</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #0066cc;">${progress.door_opening_photos}/2</div>
                    </div>
                    <div style="background: white; padding: 0.75rem; border-radius: 4px; text-align: center;">
                        <div style="font-size: 0.85rem; color: #666;">Interior Photos</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #0066cc;">${progress.interior_inspection_photos}/3</div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                    <div style="background: white; padding: 0.75rem; border-radius: 4px; text-align: center;">
                        <div style="font-size: 0.85rem; color: #666;">Cargo Photos</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #0066cc;">${progress.cargo_unloading_photos}/2</div>
                    </div>
                    <div style="background: white; padding: 0.75rem; border-radius: 4px; text-align: center;">
                        <div style="font-size: 0.85rem; color: #666;">Cargo Items</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: #0066cc;">${progress.cargo_items_count}</div>
                    </div>
                    <div style="background: white; padding: 0.75rem; border-radius: 4px; text-align: center;">
                        <div style="font-size: 0.85rem; color: #666;">Damage Status</div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: ${progress.damage_reported ? '#dc3545' : '#28a745'};">
                            ${progress.damage_reported ? '‚ö†Ô∏è Yes' : '‚úÖ No'}
                        </div>
                    </div>
                </div>
            </div>
            `;

            // Insert into modal or container
            const contentContainer = document.getElementById('import-unpacking-content') || document.querySelector('.tab-content:not([style*="display: none"])');
            if (contentContainer) {
                contentContainer.innerHTML = `
                <div style="padding: 2rem; max-width: 1400px; margin: 0 auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="margin: 0; color: #0f1d3d;">üì• Import Container Unpacking Workflow</h2>
                        <div style="font-size: 1.1rem; font-weight: 600; color: #0066cc;">Container: ${containerId.substring(0, 8)}...</div>
                    </div>
                    ${stepsHTML}
                    ${currentStepHTML}
                    ${galleryHTML}
                    ${summaryHTML}
                </div>
                `;
            }
        }

        // Helper: Get photo count for step
        function getPhotoCount(progress, step) {
            const photoCounts = {
                'EXTERIOR_INSPECTION': progress.exterior_inspection_photos,
                'DOOR_OPENING': progress.door_opening_photos,
                'INTERIOR_INSPECTION': progress.interior_inspection_photos,
                'CARGO_UNLOADING': progress.cargo_unloading_photos,
                'CARGO_MANIFEST': 1,
                'FINAL_INSPECTION': 2
            };
            return photoCounts[step] || 0;
        }

        // Helper: Get photo requirement for step
        function getPhotoRequired(step) {
            const requirements = {
                'EXTERIOR_INSPECTION': 3,
                'DOOR_OPENING': 2,
                'INTERIOR_INSPECTION': 3,
                'CARGO_UNLOADING': 2,
                'CARGO_MANIFEST': 1,
                'FINAL_INSPECTION': 2
            };
            return requirements[step] || 1;
        }

        // Upload unpacking photos
        async function uploadUnpackingPhotos(containerId) {
            const fileInput = document.getElementById(`photoUpload-${containerId}`);
            const files = fileInput.files;

            if (files.length === 0) return;

            const token = localStorage.getItem('access_token');
            const formData = new FormData();

            // Add files
            for (let file of files) {
                formData.append('photos', file);
            }

            try {
                const response = await fetch(`/api/unpacking/${containerId}/photo-upload`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(`‚úÖ ${files.length} photo(s) uploaded successfully!`);
                    
                    // Refresh progress
                    loadUnpackingInterface(containerId, currentUnpackingSession.progress);
                } else {
                    const error = await response.json();
                    alert(`‚ùå Error uploading photos: ${error.detail || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error uploading photos:', error);
                alert('‚ùå Error uploading photos: ' + error.message);
            }

            fileInput.value = '';
        }

        // Advance unpacking step
        async function advanceUnpackingStep(containerId) {
            const token = localStorage.getItem('access_token');
            
            try {
                const response = await fetch(`/api/unpacking/${containerId}/advance-step`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    alert('‚úÖ Advanced to next step!');
                    loadUnpackingInterface(containerId, currentUnpackingSession.progress);
                } else {
                    const error = await response.json();
                    alert(`‚ùå Error: ${error.detail || 'Cannot advance step'}`);
                }
            } catch (error) {
                console.error('Error advancing step:', error);
                alert('‚ùå Error advancing step: ' + error.message);
            }
        }

        // Revert unpacking step
        async function revertUnpackingStep(containerId) {
            if (!confirm('‚ö†Ô∏è Revert to previous step? This will clear photos from current step.')) return;

            const token = localStorage.getItem('access_token');
            
            try {
                const response = await fetch(`/api/unpacking/${containerId}/revert-step`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    alert('‚úÖ Reverted to previous step');
                    loadUnpackingInterface(containerId, currentUnpackingSession.progress);
                } else {
                    const error = await response.json();
                    alert(`‚ùå Error: ${error.detail || 'Cannot revert step'}`);
                }
            } catch (error) {
                console.error('Error reverting step:', error);
                alert('‚ùå Error reverting step: ' + error.message);
            }
        }

        // Show damage report modal
        function showDamageReportModal(containerId) {
            const damageDescription = prompt('Describe the damage or discrepancy found:');
            if (damageDescription) {
                reportDamage(containerId, damageDescription);
            }
        }

        // Report damage
        async function reportDamage(containerId, description) {
            const token = localStorage.getItem('access_token');
            
            try {
                const response = await fetch(`/api/unpacking/${containerId}/damage-report`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        damage_description: description
                    })
                });

                if (response.ok) {
                    alert('‚úÖ Damage report recorded');
                    loadUnpackingInterface(containerId, currentUnpackingSession.progress);
                } else {
                    const error = await response.json();
                    alert(`‚ùå Error: ${error.detail || 'Failed to report damage'}`);
                }
            } catch (error) {
                console.error('Error reporting damage:', error);
                alert('‚ùå Error reporting damage: ' + error.message);
            }
        }

        // Complete unpacking
        async function completeUnpacking(containerId) {
            const finalNotes = prompt('Enter final inspection notes (optional):');
            
            const token = localStorage.getItem('access_token');
            
            try {
                const response = await fetch(`/api/unpacking/${containerId}/complete`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        final_notes: finalNotes || ''
                    })
                });

                if (response.ok) {
                    alert('‚úÖ Unpacking workflow completed!\nContainer is now ready for final review.');
                    loadAvailableFCLContainers();
                    toggleImportUnpackingPage(false);
                } else {
                    const error = await response.json();
                    alert(`‚ùå Error: ${error.detail || 'Failed to complete unpacking'}`);
                }
            } catch (error) {
                console.error('Error completing unpacking:', error);
                alert('‚ùå Error completing unpacking: ' + error.message);
            }
        }

        // Continue unpacking
        function continueUnpacking(containerId) {
            loadUnpackingInterface(containerId, currentUnpackingSession.progress);
        }

        // View unpacking details
        function viewUnpackingDetails(containerId) {
            loadUnpackingInterface(containerId, currentUnpackingSession.progress);
        }
        </script>
        <!-- ========== END IMPORT UNPACKING FUNCTIONS ========== -->
    </div>

    <!-- 
    ================================================
    MODULAR JAVASCRIPT ARCHITECTURE (New Structure)
    ================================================
    The following files provide a modular, maintainable structure for:
    - Core utilities and API communication (core.js)
    - UI/Navigation management (ui.js)
    - Container operations (containers.js)
    - Forms and workflows (forms.js - to be created)
    
    Existing inline functions remain for backward compatibility.
    New features should use the modular architecture below.
    -->
    <script src="/static/js/core.js"></script>
    <script src="/static/js/ui.js"></script>
    <script src="/static/js/containers.js"></script>

</body>
</html>
